// SPDX-License-Identifier: MIT
pragma solidity 0.8.20;

import "forge-std/Test.sol";
import "../../../../contracts/protocol/implementation/NodePossessionVerifier.sol";

// solhint-disable max-line-length
contract NodePossessionVerifierTest is Test {
    NodePossessionVerifier private nodePossessionVerifier;
    bytes private certificateRaw;
    bytes private signature;

    function setUp() public {
        nodePossessionVerifier = new NodePossessionVerifier();
    }

    function testVerifySignature1() public {
        bytes memory messageRaw = "hello world";
        signature = hex"57a0d6a185924d9d579b3ab319fe512331cb0bc6ef2da7d5285cbd06844f5c44662cae2e41ee5020893d6690e34b50a369a78250ae81ba6d708560535ef7cff0299f2ba070b096a9a76e84cf9c902b5e367b341ee166f5fc325dd08a3d971d96d528937f617a1eaf2250c56c4edca80c65970d54fe2492a19468bd32166b3c32";
        bytes memory modulus = hex"B793F2F926170FAD768F8B1A5769A2243B4CDCAC4780194F59B39E1A2ABC3BB8EA42DB495D17BEC7F7072A11ED4FA510E75A7886A5DB6F71B7AFCA0090CA079889D18AF0669829ED29A8E21D0C09BD19CAAF2FE2CC8121BFC5687AC6698E3022F468A481426486CAD263BE1A119491E034A6E1AB78F19C066D4145A50F9ECFF7";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(messageRaw));
        assertTrue(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignature2() public {
        bytes memory messageRaw = hex"8b90a79fec955a7db26ba6737d3ed0455603d09b95c454f8013808eb3a97158954ace71ac52c341381463a45637b4853cfb07f699682da2b19d96cecb2c0e9214f74681560ba67def476108f1e7abbaf9e9cb3eabd0b3d0779e3d61ae2febdfbc40eb1f686e8fcc45223b0ba77e231410beef386d4088573697dcfdd94fa98ff";
        signature = hex"d058fc5d239b0f975fe10f3c3a6f36b0e9be32c9bd2e5c81d10d38c6d462bf08d70b1d8ce85cecbefa18f52672c9de7b152c93a89436c0eb5ede1aa78b17d07f3eecb628be117a23b5be3d5bdc48b6d50b864f4899129c3e917201963e063ed6ea428cf92b4ce358dcdde32f18e768edbf40c43caced67cdf97ca1133f8ba158b9b050ebff5bde22752b464e5740c8c6d990c44b291ddf652317a336ccef6e0e8a5f0811319c6d213fbf44ba637f8f32341eac526ea90638378956bbab749d75148d6a408b4f6c8974921bcd2274be693732e1ae3083d17fdc89653e4c22e846d32f9c18853ff03c7f3cc176175ebcccebcb760d995ab3f3c557b2b36b636382235729fc1dfbd88fa9c766daa351e0b0a4ae0d8ed63a01a45640361a0bb4056aae074e8ddf096e50bb2f49b64b20dfd475a1c5fd3860e5283bcf3dfabb952c201c0d7fecf79595267bd455f825b67f597238793b069512b65a5cf79a2fa6d2680e8004af7fbf65efdcf5912fc2d321c7b2bc969548c3da960cecd94631f75456d234ca3812a2ccad439a292dfde9fc98c1bc3e17262fdb0e167130fa8935efc84fab777d757f0dcebc76e85c8a4988bba63348af0c383a37b434ab600f80f295053e07cccc84575f8292645c2dbbf60616efa473767d47086710eb1fc2362e9784d07c314ba2d48a9ec4616e256ccc9dfb66d5444f5d0ede21c7bcf67c514683";
        bytes memory modulus = hex"d25c8f8c97b7e5a6a98de78f19ef18077cf952e64622e4142e6ba5c8ee265ea9b34b9e5cb2c1ac0307547faa70126229b32085988c0974a03198c89f8305be4bdc445ee577c60b7a7fdfd5cf7283f0a1d0f2d65b1ba2fbfb76c5039ee06a944d40ae3843c9a4d60571db4cd16e28ce5b9fb9fa83fa3cf8cfc1e87103612568ecdb1a5c50fbd0911b645983b629ba72bc2d228207b49e00bdae1b906aa15ea2d23f8c0e124c9e7de1b3cd3b9bc6a017c4de3f1d6548dacad6d4abd5f4e179a2a5e782fb8f818cf8f307f84f7f3bcd81059e73192036aca02f805070eded8b5de01037f2b34b41e86bb8c44760492cde4bc3b080d5b0624bfa1002bd6a75d0513b07c354e8edf8a6f57dc14290eb8850659788098b9971fc0492c3ced7c3478689444e771c9434fb624eb4243f740c3ef9c3f3f084bfb59f44a46a1d3b1438e661ba3ba08d525255224816348b4d696475ccac3871fc7836385f7078412cc58e36747d248bb1ab123fa33256c10d1102f77a60643f4247ac1cdfdf4d8d51deea80795964f801f97c4f955eb181136bb39abecd3549541ccc9d29e34a63241a4548e836c4d2159968596130a222608ae0b09d9ed30cbf04d83083457f60e8a686a452baa2b08c177ade1a3cbe7bc0d6ed846c24c4ad5bcaff3817fdf3381e64c39c18dd4f54eb82fc23d3139843228489399c156565df75f3808cbdfaa53594bac5";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(messageRaw));
        assertTrue(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignature3() public {
        bytes memory messageRaw = hex"02dfBdbaB95ABAeF4C51FaF26a396247263527B8";
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea2951";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(messageRaw));
        assertTrue(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignature4() public {
        bytes32 message = hex"60e727d0f74c6297883eba41cb77ba9c54c7339d96491e3c0799a9f3e8e84797";
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea2951";
        bytes memory exponent= hex"010001";

        assertTrue(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignature5() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea2951";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(voter));
        assertTrue(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignatureRevertInvalidModulusLength() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(voter));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignatureRevertInvalidSignatureLength() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf12";
        bytes memory modulus = hex"abc123";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(voter));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifyNodePossession() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        bytes20 nodeId = hex"32b9f68a5b1ea955d3c9c0885f315971b74e5d9e";
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        nodePossessionVerifier.verifyNodePossession(voter, nodeId, certificateRaw, signature);
    }

    function testVerifyNodePossessionRevertInvalidNodeId() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        bytes20 nodeId = hex"32b9f68a5b1ea955d3c9c0885f315971b74e5d9f";
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        vm.expectRevert("invalid node id");
        nodePossessionVerifier.verifyNodePossession(voter, nodeId, certificateRaw, signature);
    }

    function testVerifyNodePossessionRevertInvalidSignature() public {
        address voter = makeAddr("wrong voter");
        bytes20 nodeId = hex"32b9f68a5b1ea955d3c9c0885f315971b74e5d9e";
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        vm.expectRevert("invalid signature");
        nodePossessionVerifier.verifyNodePossession(voter, nodeId, certificateRaw, signature);
    }

    //// extractPublicKeyFromRawCertificate tests
    // couldn't read certificate element
    function testExtractRevert1() public {
        certificateRaw = hex"2082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read certificate element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read RawTBSCertificate element
    function testExtractRevert2() public {
        certificateRaw = hex"3082049d20820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read RawTBSCertificate element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read version element
    function testExtractRevert3() public {
        certificateRaw = hex"3082049d30820285b003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read version element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read serial number element
    function testExtractRevert4() public {
        certificateRaw = hex"3082049d30820285a003020102040100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read serial number element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read signature algorithm element
    function testExtractRevert5() public {
        certificateRaw = hex"3082049d30820285a003020102020100f00d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read signature algorithm identifier");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read issuer element
    function testExtractRevert6() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b0500f0003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read issuer element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read validity element
    function testExtractRevert7() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b05003000f020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read validity element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read subject element
    function testExtractRevert8() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315af00030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read subject element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read subject public key info element
    function testExtractRevert9() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a3000f0820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read subject public key info element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read algorithm element
    function testExtractRevert10() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222f00d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read algorithm element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read public key element
    function testExtractRevert11() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000f82020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read public key element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read subject public key info element
    function testExtractRevert12() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a3000f0820222300d06092a864886f70d01010105000382020f00f082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read subject public key info element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read public key data
    function testExtractRevert13() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f00f082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read public key data");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read public N element
    function testExtractRevert14() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a0f8202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510203010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read N element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    // couldn't read public E element
    function testExtractRevert15() public {
        certificateRaw = hex"3082049d30820285a003020102020100300d06092a864886f70d01010b050030003020170d3939313233313030303030305a180f32313231303832363132303434315a300030820222300d06092a864886f70d01010105000382020f003082020a028202010099e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea29510f03010001a320301e300e0603551d0f0101ff0404030204b0300c0603551d130101ff04023000300d06092a864886f70d01010b0500038202010011c87d4c6832b93c9e65bac12b34e1793c89ee27638a2e5a6861072d63290e9555a16b4acc090445573b13851a5bcf5bf5c780a00ddc35fd3b50a18e85549dade6b615795479ab142f070bd84a8de9b6280cef2e644b283b17023015d1edfc4e5d37d9f39c4c094f137fa543831ef77c4aa7687b4120c3eeaff1fd776b407e2e7cfe267a6cc24b56d157964a8964d3c3f2c8e81bae3fe0feaeb61b8050d3383a06145236e1a4f46ca90d0f9afc3bb9e6a4e255ba93f5354105c0d948835e05f330e44489e5356d2b201c26f16a7d01502e6e70a199ed7045f1c5b8ce1413b9d8eb6e7c033da379e0634c8a88077fabc20ea0dc41fb0db2fee6ff5856c4bcf5cbd17f3d5af7f32c9dc09809290c603254ecf64200f9836d208b1100e29cd5260729236002e789a55bbcb465307e16ecd027e99f3a42dfabee8accbaa48539d604f286226f81f37072a04525b2832346ff37107ed6e4201291a6b076d4c22945620e16d4c72aae436c245730d375e77cf0e099cda5ac8f80fb52a9c3d460bc9bb45c348e513107df1a2f7f0c6858417def41182ca27ac43ad420abb98f00036352c0ceb695634b171adec405e298b00cc5d81c9dd40ec562438a911eee8ff1ae96a212fa39ed98b798baa6315ce2bad16baad9b35fe5fc324098080371ad090142303f676bb8aa7f8dd4fa0131b4d4e106d6349de9e1c4718b95a9dd1d4db34596";
        vm.expectRevert("couldn't read E element");
        nodePossessionVerifier.extractPublicKeyFromRawCertificate(certificateRaw);
    }

    //// readASN1Element tests
    // data too short
    function testReadASN1ElementUnsuccessful() public {
        bytes memory data = hex"a1";
        bytes1 expectedTag = hex"12";
        (, , bool success) = nodePossessionVerifier.readASN1Element(data, expectedTag, false);
        assertEq(success, false);
    }

    // unexpected tag
    function testReadASN1ElementUnsuccessful2() public {
        bytes memory data = hex"abc123";
        bytes1 expectedTag = hex"12";
        (, , bool success) = nodePossessionVerifier.readASN1Element(data, expectedTag, false);
        assertEq(success, false);
    }

    // data too long
    function testReadASN1Unsuccessful3() public {
        bytes memory data = hex"aba1ab";
        bytes1 expectedTag = hex"ab";
        (, , bool success) = nodePossessionVerifier.readASN1Element(data, expectedTag, false);
        assertEq(success, false);
    }

    // data too short for length bytes
    function testReadASN1Unsuccessful4() public {
        bytes memory data = hex"ab82ab";
        bytes1 expectedTag = hex"ab";
        (, , bool success) = nodePossessionVerifier.readASN1Element(data, expectedTag, false);
        assertEq(success, false);
    }

    // data too short for content
    function testReadASN1Unsuccessful5() public {
        bytes memory data = hex"ab82ab1234";
        bytes1 expectedTag = hex"ab";
        (, , bool success) = nodePossessionVerifier.readASN1Element(data, expectedTag, false);
        assertEq(success, false);
    }

    function testSliceStart() public {
        bytes memory data = hex"ab82ab1234";
        bytes memory result = nodePossessionVerifier.sliceStart(data, 2);
        assertEq(result.length, 3);
        assertEq(result[0], hex"ab");
        assertEq(result[1], hex"12");
        assertEq(result[2], hex"34");

        result = nodePossessionVerifier.sliceStart(data, 5);
        assertEq(result.length, 0);
    }

    function testSliceStartRevert() public {
        bytes memory data = hex"a1";
        vm.expectRevert("start index out of bounds");
        nodePossessionVerifier.sliceStart(data, 2);
    }

    //// verify tests
    function testVerifySignatureRevertInvalidStart() public {
        address voter = 0x02dfBdbaB95ABAeF4C51FaF26a396247263527B8;
        signature = hex"7e813b5ab5cbe6e7ae24ce22f89d105771f4bbeca07d79315b610cea839fe4225a471c3195e778939f25d111316e975650defeefc7094ef0c28f0990be4e7ae407cf1dc776c431a96243b81fa1c19464102a6ea6ea57f4349bf4af9a1545d2a5d9316f52c2112ee6677c4d9006a77a1ac1c05f503a4f0b3e8eda5e8d52b1599cd7a99f9a563608ebadc125f713b11a87ff3df508330fcfb6d318033d002f77e86887a1141105c59d27f6d1a696a1db732255cd1e6b0760a5be1ba8fdb34a7f33024ebe3addeaee874f8118fe50da3d439199a261ae1bb751dfe67a54e532433040ffe95f76e04bbe42f789a77cc2560ea0939010471093366b8fd1812ab6b2a558707012952b8dfe7adf5dc1b36f2af29a6d3d0f360784233f8131f94ec97aafd795de1f5fd80d2665315ba61ff3aadcab4559f498b8916adeda09621dff8e4e14fff8966932edfc98aedb6faf3cc0195139f76bf7a4e1c00f42dd3cd1d90d23ebdee9f2d770f1931c5efee1f629b6e9a92a5663f2029b9b71631c7a39c115e03af14eb5c3516937d56926340389dd2d6ec34087e69cd1b3f1392429093342980bc3ef85476ff07ae1e702ada5c800406e6722a0fe89e7fe21fbd87e0b016095b80b3d1f6e11aad34f57d9a0745dce05c782c4f16802df74a93f4f3f69b373e2e1e309277a901292b8364e1aa4fc360862a259c7287ce5005dffd1796caf20cf";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea2952";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(voter));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignatureRevertInvalidMessageHash() public {
        bytes memory messageRaw = hex"8b90a79fec955a7db26ba6737d3ed0455603d09b95c454f8013808eb3a97158954ace71ac52c341381463a45637b4853cfb07f699682da2b19d96cecb2c0e9214f74681560ba67def476108f1e7abbaf9e9cb3eabd0b3d0779e3d61ae2febdfbc40eb1f686e8fcc45223b0ba77e231410beef386d4088573697dcfdd94fa98ff";
        signature = hex"d058fc5d239b0f975fe10f3c3a6f36b0e9be32c9bd2e5c81d10d38c6d462bf08d70b1d8ce85cecbefa18f52672c9de7b152c93a89436c0eb5ede1aa78b17d07f3eecb628be117a23b5be3d5bdc48b6d50b864f4899129c3e917201963e063ed6ea428cf92b4ce358dcdde32f18e768edbf40c43caced67cdf97ca1133f8ba158b9b050ebff5bde22752b464e5740c8c6d990c44b291ddf652317a336ccef6e0e8a5f0811319c6d213fbf44ba637f8f32341eac526ea90638378956bbab749d75148d6a408b4f6c8974921bcd2274be693732e1ae3083d17fdc89653e4c22e846d32f9c18853ff03c7f3cc176175ebcccebcb760d995ab3f3c557b2b36b636382235729fc1dfbd88fa9c766daa351e0b0a4ae0d8ed63a01a45640361a0bb4056aae074e8ddf096e50bb2f49b64b20dfd475a1c5fd3860e5283bcf3dfabb952c201c0d7fecf79595267bd455f825b67f597238793b069512b65a5cf79a2fa6d2680e8004af7fbf65efdcf5912fc2d321c7b2bc969548c3da960cecd94631f75456d234ca3812a2ccad439a292dfde9fc98c1bc3e17262fdb0e167130fa8935efc84fab777d757f0dcebc76e85c8a4988bba63348af0c383a37b434ab600f80f295053e07cccc84575f8292645c2dbbf60616efa473767d47086710eb1fc2362e9784d07c314ba2d48a9ec4616e256ccc9dfb66d5444f5d0ede21c7bcf67c514683";
        bytes memory modulus = hex"d25c8f8c97b7e5a6a98de78f19ef18077cf952e64622e4142e6ba5c8ee265ea9b34b9e5cb2c1ac0307547faa70126229b32085988c0974a03198c89f8305be4bdc445ee577c60b7a7fdfd5cf7283f0a1d0f2d65b1ba2fbfb76c5039ee06a944d40ae3843c9a4d60571db4cd16e28ce5b9fb9fa83fa3cf8cfc1e87103612568ecdb1a5c50fbd0911b645983b629ba72bc2d228207b49e00bdae1b906aa15ea2d23f8c0e124c9e7de1b3cd3b9bc6a017c4de3f1d6548dacad6d4abd5f4e179a2a5e782fb8f818cf8f307f84f7f3bcd81059e73192036aca02f805070eded8b5de01037f2b34b41e86bb8c44760492cde4bc3b080d5b0624bfa1002bd6a75d0513b07c354e8edf8a6f57dc14290eb8850659788098b9971fc0492c3ced7c3478689444e771c9434fb624eb4243f740c3ef9c3f3f084bfb59f44a46a1d3b1438e661ba3ba08d525255224816348b4d696475ccac3871fc7836385f7078412cc58e36747d248bb1ab123fa33256c10d1102f77a60643f4247ac1cdfdf4d8d51deea80795964f801f97c4f955eb181136bb39abecd3549541ccc9d29e34a63241a4548e836c4d2159968596130a222608ae0b09d9ed30cbf04d83083457f60e8a686a452baa2b08c177ade1a3cbe7bc0d6ed846c24c4ad5bcaff3817fdf3381e64c39c18dd4f54eb82fc23d3139843228489399c156565df75f3808cbdfaa53594bac5";
        bytes memory exponent= hex"010001";

        bytes32 message = keccak256(abi.encodePacked(messageRaw));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignatureRevertUnsupportedVersion() public {
        bytes memory messageRaw = "This is message";
        // signed with sha224 instead of sha256
        signature = hex"7cf7e51339197812286383851021443a678bf559be3d5079f4ceb8ab996d0b23feceea28fd25ade86a0ceb617db0486a7fca6e5039f9717ca4a5da47b411b9f0126d7e6682013bdedc3754b152556a1b757e1a92dcac09e861faaaf620afe7356103c7f56385df44232daba889072c93622aae6bb9063418be50b8f653bd2505df24967b4e6ae84098ee6092c39263b11e54653f07407f6466efc66e45bb2dc99f863ed5cf16406752cabfe50704b253eaac51daebdab0852f46343690f72c4cd4b4fc19d0d58e0f2e792cdaaff31694a7fef33cd12926bb5b20eb040a18b6ca8d878b70cfc767582fb684fb5f9a5c393295bb5b714cfc7930b13a9b0706a87ed5da523403605c95a4fbe80f93f56efae16d9b90bb7166eac473d1435d340ccfcc31fb693d40811bc31816f32f59d2a9e655df8b54fdc126850d2d362f14e3748b51a0364d60ae0e10d6c9f6c0ef1d4559e1d740e945c330350a16bfd70d0045c60154b550ae5d1596bc8156967815725c74dc2aba6c69a78a20eb5a24377ff4ec485fd5027360eeed49bddf6bb09a0cda4a13c4118f750ef508f5ecf4284d124cdef47da95e9ee6010627d642c4d6cf9553962923db9f68a7935235d6ec8027ffe81539a62ed35a3e8bbd61073532bcc2df8ee8c98b8cfb75db07345237545d6a9e4f5b6b0cbdfbb048687dfdadd719a9aba91aab60c3a78b1f5068a3993943";
        bytes memory modulus = hex"99e217cbbf20cf9bfe7d6270fa40bb82bcd315a1c67b137cad4a8523c1ef3c89203ac51639b8603d0c9542da57274b53746c0c0f2a1e81efdde8f9faa54a2d54ea26d908802b6d5745f7efb7fb8efe2ad4b1253f796a64b2759794070a1b558a7e739f6004a43ae3b5b4ceca2e65cc9a287189ace9387032a27a7cdd02622774c2d06df4d7073683ec4085645de31211f6fcde58817151bd81a18df19e2ee2baa88ece4f4d1ad12b35749ed1835ba34de10044099b9e2d54b141c1953f7c641e7dac13851f6c31ff3097b3a20ea0793cd3105562ae34f090e8193c6ab8b230d5e1ca65266184b922c8c65fd22e5106e58344449d1f185e738efc870fcf185f1699a985510074c84a966fcf915dc2e74daa9f15dfa8629a73088a96782e1676a6da7844670c9975d99392bdbfe5161bde984bc74933cd96cfe4ed6d1f70ccd89e218cb98c046c05da799734e45e607837efe02f00401ee44ca6fe6c83ea47699726de092c5f03561c5cc20e4ba26e4e2f8697276f2603a4663471e87a0b51deaecd966f4ede5fcaa275cd0ec377531dc82c90d62d27b401f244935273a18945c4c3f98b6f6a8e4fe58dc95decd12190882d2de7695d41c675d41ef5bf6075a47359e2302b7c62077a0162f9afb78f404e590650d194183f78900f697f2b9e854c617a3c29b04ab6f11e92992702c5f8fd46f4543b699897bd886194fb4eea2951";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(messageRaw));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }

    function testVerifySignatureRevertInvalidVersion() public {
        bytes memory messageRaw = hex"b8518b80a55b365eb1850e18f88da2941c99543c2f865df3d37d114d9fc764ffc5e2ae94f2d4ab6276bfc6bda5b6976a7dcfaa56897982880410dd5542af3ad34c469990cbec828327764842ef488f767c6b0c8cd1e08caec63438f2665517d195a4d4daf64bc2a70bd11d119eec93a060960245d162844c5f11a98cd26003e1";
        signature = hex"06317d3df0fa7ae350729ae2096b050dcec8909d36681ccca09a7a527b90767f8c2318c49e09483b48df77ddb632d6ca721155165389f7795d3ede70465678649399242aed6d984ca74fc6c2eb4dd4bb2cd7bf2125ec853f2bf757d665b29487bc5b63df0d0b03b18608d3d9a7576ea0954aef3d3303f7d8fd7e7f9725c114e2";
        bytes memory modulus = hex"a8d68acd413c5e195d5ef04e1b4faaf242365cb450196755e92e1215ba59802aafbadbf2564dd550956abb54f8b1c917844e5f36195d1088c600e07cada5c080ede679f50b3de32cf4026e514542495c54b1903768791aae9e36f082cd38e941ada89baecada61ab0dd37ad536bcb0a0946271594836e92ab5517301d45176b5";
        bytes memory exponent= hex"010001";

        bytes32 message = sha256(abi.encodePacked(messageRaw));
        assertFalse(nodePossessionVerifier.verifyPKCS1v15SHA256(message, signature, modulus, exponent));
    }
}



